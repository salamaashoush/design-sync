import f from"path";import x from"fs";import m from"module";import{parseTsconfig as F,getTsconfig as y,createFilesMatcher as j,createPathsMatcher as E}from"get-tsconfig";import{installSourceMapSupport as O,shouldStripSourceMap as g,stripSourceMap as M}from"../source-map.mjs";import{p as P,a as b,b as A}from"../index-c4b20163.mjs";import{r as N}from"../resolve-ts-path-a8cb04a4.mjs";import"source-map-support";import"../node-features-a792cc3d.mjs";import"url";import"esbuild";import"crypto";import"os";const R=o=>{if(o.includes("import")||o.includes("export")){const[s,r]=P(o);return s.length>0||r.length>0}return!1},I=/^\.{1,2}\//,C=/\.[cm]?tsx?$/,D=`${f.sep}node_modules${f.sep}`,a=process.env.TSX_TSCONFIG_PATH?{path:f.resolve(process.env.TSX_TSCONFIG_PATH),config:F(process.env.TSX_TSCONFIG_PATH)}:y(),T=a&&j(a),_=a&&E(a),v=O(),l=m._extensions,G=l[".js"],H=[".cts",".mts",".ts",".tsx",".jsx"],X=[".js",".cjs",".mjs"],h=(o,s)=>{process.send&&process.send({type:"dependency",path:s});const r=H.some(e=>s.endsWith(e)),n=X.some(e=>s.endsWith(e));if(!r&&!n)return G(o,s);let t=x.readFileSync(s,"utf8");if(g&&(t=M(t)),s.endsWith(".cjs")){const e=b(s,t);e&&(t=v(e,s))}else if(r||R(t)){const e=A(t,s,{tsconfigRaw:T==null?void 0:T(s)});t=v(e,s)}o._compile(t,s)};[".js",".ts",".tsx",".jsx"].forEach(o=>{l[o]=h}),Object.defineProperty(l,".mjs",{value:h,enumerable:!1});const p=m._resolveFilename.bind(m);m._resolveFilename=(o,s,r,n)=>{var t;const e=o.indexOf("?");if(e!==-1&&(o=o.slice(0,e)),_&&!I.test(o)&&!((t=s==null?void 0:s.filename)!=null&&t.includes(D))){const i=_(o);for(const d of i){const u=S(d,s,r,n);if(u)return u;try{return p(d,s,r,n)}catch{}}}const c=S(o,s,r,n);return c||p(o,s,r,n)};const S=(o,s,r,n)=>{const t=N(o);if(s!=null&&s.filename&&C.test(s.filename)&&t)for(const e of t)try{return p(e,s,r,n)}catch(c){const{code:i}=c;if(i!=="MODULE_NOT_FOUND"&&i!=="ERR_PACKAGE_PATH_NOT_EXPORTED")throw c}};
